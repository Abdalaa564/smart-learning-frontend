<div class="container py-4">
  <!-- Add Course Button -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold">Courses</h3>
    <button class="btn btn-success btn-sm" [routerLink]="['/courses/add']" *ngIf="isAdmin">
      + Add New Course</button>
  </div>

  <!-- ===== Skeleton Loading State ===== -->
  <div class="row" *ngIf="isLoading">
    <div class="col-xl-3 col-lg-3 col-md-4 col-sm-6 mb-4" *ngFor="let i of [1,2,3,4,5,6,7,8]">
      <app-skeleton-card [showImage]="true" [lines]="3" [showActions]="true" imageHeight="200px" animation="wave">
      </app-skeleton-card>
    </div>
  </div>

  <!-- ===== Course Cards ===== -->
  <div class="row g-4" *ngIf="!isLoading">
    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngFor="let course of paginatedCourses">

      <div class="course-card h-100 shadow-sm" (click)="goToUnits(course)">

        <!-- Image -->
        <div class="course-image-wrapper">
          <img [src]="getCourseImage(course)" [alt]="course.crs_Name" class="course-image" alt="" />
          <div class="course-price">{{ course.price }} EGP</div>
        </div>

        <!-- Content -->
        <div class="course-content d-flex flex-column">
          <div class="course-meta mb-2">
            <span class="badge category">Programming</span>
            <span class="badge level">All Levels</span>
          </div>

          <h5 class="card-title">{{ course.crs_Name }}</h5>
          <p class="card-text ">{{ course.crs_Description }}</p>

          <div class="instructor-info mb-3">
            <img [src]="getInstructorImage(course)" alt="Instructor" class="instructor-avatar" />
            <span>{{ getInstructorName(course) }}</span>
          </div>

          <!-- Edit/Delete Buttons -->
          <div class="d-flex justify-content-between align-items-center mt-auto">
            <button class="btn btn-sm btn-outline-accent grow me-2" (click)="viewDetails(course)">
              View Details
            </button>

            <div class="icon-actions d-flex gap-2">
              <button *ngIf="isAdmin" class="icon-btn-new btn btn-sm btn-light"
                [routerLink]="['/courses/edit', course.crs_Id]" (click)="$event.stopPropagation()" title="Edit">
                <i class="bi bi-pencil-square text-primary"></i>
              </button>

              <button *ngIf="isAdmin" class="icon-btn-new btn btn-sm btn-light"
                [routerLink]="['/Courses/delete', course.crs_Id]" (click)="$event.stopPropagation()" title="Delete">
                <i class="bi bi-trash text-danger"></i>
              </button>
            </div>
          </div>

          <!-- Enroll Button -->
          <div class="enroll-section mt-3" (click)="$event.stopPropagation()" *ngIf="isStudent">
            <button *ngIf="!isEnrolledInCourse(course.crs_Id)" class="btn btn-primary w-100" (click)="enroll(course)"
              [disabled]="isEnrolling(course.crs_Id)">

              <span *ngIf="!isEnrolling(course.crs_Id)">
                <i class="fa fa-graduation-cap me-2"></i> Enroll Now
              </span>

              <span *ngIf="isEnrolling(course.crs_Id)">
                <span class="spinner-border spinner-border-sm me-2"></span> Enrolling...
              </span>
            </button>

            <div *ngIf="isEnrolledInCourse(course.crs_Id)" class="alert alert-success text-center mb-0 mt-2">
              <i class="fa fa-check-circle me-2"></i> Enrolled
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enrollment Confirmation Modal -->
<div class="modal fade" [class.show]="showEnrollModal" [style.display]="showEnrollModal ? 'block' : 'none'"
  tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" *ngIf="selectedCourse">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fa fa-graduation-cap me-2"></i>
          Confirm Enrollment
        </h5>

        <button type="button" class="btn-close btn-close-white" (click)="closeEnrollModal()"
          [disabled]="enrollingCourseId !== null">
        </button>
      </div>

      <div class="modal-body">
        <div class="text-center mb-3">
          <img alt="" [src]="getCourseImage(selectedCourse)" [alt]="selectedCourse.crs_Name"
            class="img-fluid rounded shadow-sm" style="max-height: 200px; object-fit: cover; width: 100%" />
        </div>

        <h4 class="text-center mb-3">{{ selectedCourse.crs_Name }}</h4>

        <div class="enrollment-details bg-light rounded p-3 mb-3">

          <div class="detail-row d-flex justify-content-between py-2 border-bottom">
            <span class="text-muted">
              <i class="fa fa-chalkboard-teacher me-2"></i>Instructor:
            </span>
            <span class="fw-semibold">{{ getInstructorName(selectedCourse) }}</span>
          </div>

          <div class="detail-row d-flex justify-content-between py-2 border-bottom">
            <span class="text-muted">
              <i class="fa fa-money-bill-wave me-2"></i>Price:
            </span>
            <span class="fw-bold text-success">{{ selectedCourse.price }} EGP</span>
          </div>

          <div class="detail-row d-flex justify-content-between py-2">
            <span class="text-muted">
              <i class="fa fa-credit-card me-2"></i>Payment Method:
            </span>
            <span class="fw-semibold">Credit Card ðŸ’³</span>
          </div>
        </div>

        <div class="alert alert-info mb-0">
          <i class="fa fa-info-circle me-2"></i>
          <small>You will be charged <strong>{{ selectedCourse.price }} EGP</strong>.</small>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEnrollModal()"
          [disabled]="enrollingCourseId !== null">
          Cancel
        </button>

        <button type="button" class="btn btn-primary" (click)="confirmEnrollment()"
          [disabled]="enrollingCourseId !== null">

          <span *ngIf="enrollingCourseId === null">
            <i class="fa fa-check me-2"></i> Confirm & Pay
          </span>

          <span *ngIf="enrollingCourseId !== null">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Processing...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Payment Iframe Modal -->
<div class="modal fade" [class.show]="showPaymentIframe" [style.display]="showPaymentIframe ? 'block' : 'none'"
  tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fa fa-credit-card me-2"></i>Complete Payment
        </h5>

        <button type="button" class="btn-close btn-close-white" (click)="closePaymentIframe()"></button>
      </div>

      <div class="modal-body p-0">
        <iframe *ngIf="showPaymentIframe" [src]="paymentUrl | safe : 'resourceUrl'" width="100%" height="600"
          frameborder="0"></iframe>
      </div>

    </div>
  </div>
</div>

<!-- Result Modal -->
<div class="modal fade" [class.show]="showResultModal" [style.display]="showResultModal ? 'block' : 'none'"
  tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header" [class.bg-success]="enrollmentSuccess" [class.bg-danger]="!enrollmentSuccess"
        [class.text-white]="true">

        <h5 class="modal-title">
          <i class="fa" [class.fa-check-circle]="enrollmentSuccess" [class.fa-times-circle]="!enrollmentSuccess"
            class="me-2"></i>
          {{ enrollmentSuccess ? 'Enrollment Successful!' : 'Enrollment Failed' }}
        </h5>

        <button type="button" class="btn-close btn-close-white" (click)="closeResultModal()"></button>
      </div>

      <div class="modal-body text-center py-4">
        <div class="result-icon mb-3">
          <i class="fa fa-5x" [class.fa-check-circle]="enrollmentSuccess" [class.fa-times-circle]="!enrollmentSuccess"
            [class.text-success]="enrollmentSuccess" [class.text-danger]="!enrollmentSuccess">
          </i>
        </div>

        <p class="lead mb-3">{{ enrollmentMessage }}</p>

        <div *ngIf="enrollmentSuccess && transactionId" class="alert alert-success">
          <small>
            <i class="fa fa-receipt me-2"></i>
            <strong>Transaction ID:</strong> {{ transactionId }}
          </small>
        </div>

        <div *ngIf="enrollmentSuccess" class="mt-3">
          <p class="text-muted">
            <i class="fa fa-envelope me-2"></i>
            A confirmation email has been sent.
          </p>
        </div>
      </div>

      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" (click)="closeResultModal()">
          Close
        </button>

        <button *ngIf="enrollmentSuccess" type="button" class="btn btn-primary" (click)="goToMyCourses()">
          <i class="fa fa-graduation-cap me-2"></i> View My Courses
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Pagination -->
<div class="mt-4 mb-3" *ngIf="!isLoading">
  <app-pagination [currentPage]="currentPage" [totalItems]="courses.length" [itemsPerPage]="itemsPerPage"
    (pageChange)="onPageChange($event)">
  </app-pagination>
</div>

<!-- Modal Backdrops -->
<div class="modal-backdrop fade" [class.show]="showEnrollModal || showPaymentIframe"
  *ngIf="showEnrollModal || showPaymentIframe">
</div>

<div class="modal-backdrop fade" [class.show]="showResultModal" *ngIf="showResultModal">
</div>