<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Lesson Details</h3>

    <div class="d-flex gap-2">
      <a class="btn btn-secondary btn-sm" (click)="goBack()">
        ‚Üê Back to Lessons
      </a>

      <a class="btn btn-primary btn-sm"
         [routerLink]="['/Courses', courseId, 'units', unitId, 'lessons', lessonId, 'edit']">
        Edit
      </a>

      <a class="btn btn-danger btn-sm"
         [routerLink]="['/Courses', courseId, 'units', unitId, 'lessons', lessonId, 'delete']">
        Delete
      </a>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="alert alert-info">
    <span class="spinner-border spinner-border-sm me-2"></span>
    Loading lesson details...
  </div>

  <!-- Access Denied - Locked Content -->
  <div *ngIf="!isLoading && !canAccessContent" class="card border-warning shadow-sm">
    <div class="card-body text-center py-5">
      <div class="mb-4">
        <i class="bi bi-lock-fill text-warning" style="font-size: 4rem;"></i>
      </div>
      
      <h4 class="fw-bold mb-3">üîí Premium Content</h4>
      <p class="lead text-muted mb-4">{{ errorMessage }}</p>
      
      <div class="alert alert-info d-inline-block mb-4">
        <i class="bi bi-gift-fill me-2"></i>
        <strong>Free Preview Available:</strong> Access the first 3 lessons of Unit 1 for free!
      </div>

      <div>
        <button class="btn btn-success btn-lg px-5" (click)="goToEnroll()">
          <i class="bi bi-graduation-cap me-2"></i>
          Enroll in Course
        </button>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="!isLoading && canAccessContent && errorMessage && !lesson" 
       class="alert alert-danger">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {{ errorMessage }}
  </div>

  <!-- Lesson Content (Only if access granted) -->
  <div *ngIf="!isLoading && canAccessContent && lesson">

    <!-- Free Preview Badge -->
    <div *ngIf="!isEnrolled && unitId === freeUnitId && currentLessonIndex < freeLessonsLimit" 
         class="alert alert-success mb-4">
      <i class="bi bi-gift-fill me-2"></i>
      <strong>Free Preview Lesson</strong> - Enjoying the content? 
      <a [routerLink]="['/Courses']" class="alert-link fw-bold">Enroll now</a> 
      to access all lessons!
    </div>

    <!-- Enrolled Badge -->
    <div *ngIf="isEnrolled" class="alert alert-primary mb-4">
      <i class="bi bi-check-circle-fill me-2"></i>
      <strong>You're enrolled!</strong> You have full access to this course content.
    </div>

    <!-- Lesson Title & Description -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <span class="badge bg-primary mb-2">Lesson #{{ lesson.lesson_Id }}</span>
            <h4 class="fw-bold mb-0">{{ lesson.lesson_Name }}</h4>
          </div>
          
          <div>
            <span class="badge bg-success" *ngIf="isEnrolled">
              <i class="bi bi-check-circle me-1"></i>Enrolled
            </span>
            <span class="badge bg-info" *ngIf="!isEnrolled">
              <i class="bi bi-eye me-1"></i>Free Preview
            </span>
          </div>
        </div>
        
        <p class="text-muted mb-0" *ngIf="lesson.lessonDescription">
          {{ lesson.lessonDescription }}
        </p>
      </div>
    </div>

    <!-- Resources Section -->
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h5 class="mb-0">
          <i class="bi bi-folder2-open me-2"></i>
          Lesson Resources
        </h5>
      </div>
      
      <div class="card-body">
        <!-- Has Resources -->
        <ul class="list-group list-group-flush" *ngIf="lesson.resources && lesson.resources.length > 0">
          <li class="list-group-item" *ngFor="let r of lesson.resources">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ r.resource_Name }}</strong>
                <span class="badge bg-secondary ms-2">{{ r.resource_Type }}</span>
              </div>
              
              <a *ngIf="r.resource_Url" 
                 [href]="r.resource_Url" 
                 target="_blank"
                 class="btn btn-sm btn-outline-primary">
                <i class="bi bi-box-arrow-up-right me-1"></i>
                Open
              </a>
            </div>
            
            <!-- PDF Preview for PDF resources -->
            <div *ngIf="r.resource_Type === 'pdf' && r.resource_Url" class="mt-3">
              <div class="border rounded p-2 bg-light">
                <iframe 
                  [src]="r.resource_Url | safe: 'resourceUrl'"
                  style="width: 100%; height: 500px; border: none;"
                  class="rounded">
                </iframe>
              </div>
              <div class="mt-2 text-end">
                <a [href]="r.resource_Url" 
                   target="_blank" 
                   download
                   class="btn btn-sm btn-success">
                  <i class="bi bi-download me-1"></i>
                  Download PDF
                </a>
              </div>
            </div>
          </li>
        </ul>

        <!-- No Resources -->
        <div *ngIf="!lesson.resources || lesson.resources.length === 0" 
             class="text-center py-4 text-muted">
          <i class="bi bi-inbox display-4 d-block mb-3"></i>
          <p class="mb-0">No resources available for this lesson.</p>
        </div>
      </div>
    </div>

  </div>

</div>