<div class="container py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="fw-bold mb-1">Lessons for Unit #{{ unitId }}</h3>
      <p class="text-muted mb-0" *ngIf="unit">
        Unit: <strong>{{ unit.unit_Name }}</strong>
        <span *ngIf="unit.crs_Id" class="text-secondary ms-2">
          (Course #{{ unit.crs_Id }})
        </span>
      </p>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-success btn-sm px-3"
         *ngIf="isAdmin"
         [routerLink]="['/Courses', courseId, 'units', unitId, 'lessons', 'add']">
        + Add Lesson
      </a>

      <a class="btn btn-outline-secondary btn-sm px-3"
         [routerLink]="['/Courses', courseId, 'units']">
        ‚Üê Back to Units
      </a>
    </div>
  </div>

  <!-- Lessons Grid -->
  <div class="row g-4">
    <div class="col-lg-4 col-md-6 col-sm-12"
         *ngFor="let lesson of lessons; let i = index">

      <div class="card lesson-card shadow-sm h-100">

        <!-- PDF Thumbnail -->
        <div class="card-img-top lesson-image-wrapper d-flex justify-content-center align-items-center p-4">
          <img [src]="getPdfThumbnail(lesson)" class="lesson-thumb" alt="Lesson PDF thumbnail" />
        </div>

        <!-- Body -->
        <div class="card-body d-flex flex-column">

          <div class="d-flex justify-content-between mb-2 align-items-center">
            <span class="badge bg-primary">Lesson</span>
            <small class="text-muted">#{{ lesson.lesson_Id }}</small>
          </div>

          <h5 class="card-title mb-2">{{ lesson.lesson_Name }}</h5>
          <p class="card-text mb-2">{{ lesson.lessonDescription }}</p>

          <p class="text-secondary small mb-3">
            <strong>Unit:</strong> {{ unit?.unit_Name }}
          </p>

          <!-- Free or Locked -->
          <div *ngIf="canAccessLesson(i); else lockedLesson" class="mb-3">

            <a class="btn btn-success w-100 mb-2"
               [routerLink]="['/Courses', courseId, 'units', unitId, 'lessons', lesson.lesson_Id]">
              <i class="bi bi-book me-1"></i> Open Lesson
            </a>

            <a *ngIf="getPdfDownloadUrl(lesson) as pdfUrl"
               [href]="pdfUrl"
               target="_blank"
               class="btn btn-outline-primary w-100">
              <i class="bi bi-file-earmark-arrow-down me-1"></i> Download PDF
            </a>

          </div>

          <ng-template #lockedLesson>
            <div class="alert alert-warning text-center py-2 mb-2">
              <i class="bi bi-lock-fill me-1"></i> Locked - Enroll to access
            </div>

            <a class="btn btn-primary w-100"
               [routerLink]="['/Courses']">
              <i class="bi bi-unlock-fill me-1"></i> Enroll Now
            </a>
          </ng-template>

          <!-- QUIZZES FOR STUDENT -->
          <div *ngIf="quizzesByLesson[lesson.lesson_Id]?.length 
                      && !isInstructor && !isAdmin 
                      && canAccessLesson(i)"
               class="mt-3 border-top pt-2">

            <div *ngFor="let quiz of quizzesByLesson[lesson.lesson_Id]" class="mb-3">

              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="badge bg-info">Quiz: {{ quiz.quiz_Name }}</span>
                <small class="text-muted">Marks: {{ quiz.totalMarks }}</small>
              </div>

              <!-- Start Quiz -->
             <button *ngIf="!quizResults[quiz.quiz_Id]"
        class="btn btn-outline-success btn-sm w-100 mb-2"
        (click)="startQuiz(quiz)"
        [disabled]="quizLoading[quiz.quiz_Id]">
  <i class="bi bi-play-circle me-1"></i>
  {{ quizLoading[quiz.quiz_Id] ? 'Starting...' : 'Start Quiz' }}
</button>

              <!-- View Result -->
        <button class="btn btn-outline-secondary btn-sm w-100 mb-2"
        (click)="goToResult(quiz.quiz_Id)">
  <i class="bi bi-clipboard-check me-1"></i> View Result
</button>


             

            </div>

            <!-- ERROR MESSAGE -->
            <div *ngIf="quizError" class="alert alert-danger py-1 mt-1">
              {{ quizError }}
            </div>

          </div>

          <!-- Admin / Instructor Actions -->
          <div class="mt-auto d-flex justify-content-between gap-1 flex-wrap"
               *ngIf="isInstructor || isAdmin">

            <a *ngIf="isInstructor"
               class="btn btn-outline-secondary btn-sm grow"
               [routerLink]="['/Courses', courseId, 'units', unitId, 'lessons', lesson.lesson_Id]">
              <i class="bi bi-eye"></i>
            </a>

            <a class="btn btn-outline-primary btn-sm grow"
               *ngIf="isInstructor || isAdmin"
               [routerLink]="[
                 '/Courses',
                 courseId,
                 'units',
                 unitId,
                 'lessons',
                 lesson.lesson_Id,
                 'edit'
               ]">
              <i class="bi bi-pencil"></i>
            </a>

            <a class="btn btn-outline-warning btn-sm grow"
               *ngIf="isInstructor || isAdmin"
               [routerLink]="['/lesson', lesson.lesson_Id, 'create-quiz']">
              <i class="bi bi-question-circle"></i>
            </a>

            <button class="btn btn-outline-danger btn-sm grow"
                    *ngIf="isAdmin"
                    (click)="onDeleteLesson(lesson)">
              <i class="bi bi-trash"></i>
            </button>

          </div>

        </div>
      </div>

    </div>
  </div>

</div>
