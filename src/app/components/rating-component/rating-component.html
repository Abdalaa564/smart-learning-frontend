<div class="rating-container" *ngIf="lessonId">

  <h3>تقييم الدرس</h3>

  <!-- Summary -->
  <div class="rating-summary" *ngIf="average">
    <div class="avg">
      <span class="avg-value">
        {{ average.average ? (average.average | number: '1.1-2') : 'لا يوجد' }}
      </span>
      <span class="avg-label">متوسط التقييم</span>
    </div>
    <div class="count">
      <span>{{ average.count }}</span>
      <span>عدد التقييمات</span>
    </div>
  </div>

  <!-- Messages -->
  <div class="alert alert-success" *ngIf="successMessage">
    {{ successMessage }}
  </div>
  <div class="alert alert-danger" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <!-- Form -->
  <form [formGroup]="ratingForm" (ngSubmit)="onSubmit()">
    <div class="stars">
      <span
        *ngFor="let star of stars"
        class="star"
        [class.filled]="star <= ratingForm.value.ratingValue"
        (click)="setRating(star)"
      >
        ★
      </span>
    </div>
    <div class="current-rating">
      تقييمك: {{ ratingForm.value.ratingValue || 0 }} / 5
    </div>

    <div class="form-group">
      <label for="feedback">ملاحظات (اختياري)</label>
      <textarea
        id="feedback"
        formControlName="feedback"
        rows="3"
        placeholder="اكتب رأيك في الدرس..."
      ></textarea>
      <div class="error" *ngIf="ratingForm.get('feedback')?.hasError('maxlength')">
        الحد الأقصى 1000 حرف.
      </div>
    </div>

    <button type="submit" [disabled]="isLoading || ratingForm.invalid || ratingForm.value.ratingValue === 0">
      {{ myRating ? 'تعديل التقييم' : 'إضافة التقييم' }}
    </button>

    <button
      type="button"
      class="secondary"
      *ngIf="myRating"
      (click)="deleteMyRating()"
      [disabled]="isLoading"
    >
      حذف تقييمي
    </button>
  </form>

  <!-- List of ratings -->
  <div class="ratings-list" *ngIf="ratings?.length">
    <h4>كل التقييمات</h4>
    <div class="rating-item" *ngFor="let r of ratings">
      <div class="rating-header">
        <span class="stars-small">
          <span
            *ngFor="let star of stars"
            class="star"
            [class.filled]="star <= r.ratingValue"
          >
            ★
          </span>
        </span>
        <span class="user-id">{{ r.user_Id }}</span>
      </div>
      <p class="feedback" *ngIf="r.feedback">
        {{ r.feedback }}
      </p>
    </div>
  </div>

</div>

