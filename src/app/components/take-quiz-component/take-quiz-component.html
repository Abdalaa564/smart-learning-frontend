<!-- src/app/components/take-quiz/take-quiz.component.html -->

<div class="container mt-4" *ngIf="!loading && quiz">

  <!-- Overlay عند انتهاء الوقت أو أثناء الإرسال -->
  <div *ngIf="isTimeUp || submitting" class="time-up-overlay">
    <div class="text-center">
      <h3 *ngIf="isTimeUp">Time is up! Submitting your answers...</h3>
      <h3 *ngIf="submitting && !isTimeUp">Submitting your answers...</h3>
      <div class="spinner-border text-light mt-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>

  <!-- Quiz Header -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h3 class="mb-0">{{ quiz.quiz_Name }}</h3>
          <p class="text-muted mb-0">Total Marks: {{ quiz.totalMarks }}</p>
        </div>
        <div class="col-md-6 text-md-end">
          <div 
            class="timer" 
            [class.timer-warning]="timeRemaining < 300 && timeRemaining > 0"
            [class.text-danger]="timeRemaining === 0 || isTimeUp">
            <i class="bi bi-clock"></i>
            <span class="fs-4 fw-bold ms-2">{{ formattedTime }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="mb-4">
    <div class="d-flex justify-content-between mb-2">
      <span>Question {{ currentQuestionIndex + 1 }} of {{ quiz.questions.length }}</span>
      <span>{{ selectedAnswers.size }} / {{ quiz.questions.length }} Answered</span>
    </div>
    <div class="progress" style="height: 10px;">
      <div 
        class="progress-bar bg-success" 
        role="progressbar" 
        [style.width.%]="progressPercentage">
      </div>
    </div>
  </div>

  <!-- Question Card -->
  <div class="card mb-4 shadow-sm" *ngIf="currentQuestion">
    <div class="card-body">
      <div class="mb-3">
        <span class="badge bg-primary">{{ currentQuestion.grade_Point }} Points</span>
      </div>
      
      <h5 class="mb-4">{{ currentQuestion.question_Text }}</h5>

      <!-- Choices -->
      <div class="choices">
        <div 
          *ngFor="let choice of currentQuestion.choices" 
          class="choice-item mb-3"
          [class.selected]="isAnswerSelected(choice.choiceId)"
          [class.disabled]="isTimeUp || submitting"
          [style.pointer-events]="(isTimeUp || submitting) ? 'none' : 'auto'"
          (click)="selectAnswer(choice.choiceId)">
          <div class="form-check">
            <input placeholder="choice"
              class="form-check-input" 
              type="radio" 
              [checked]="isAnswerSelected(choice.choiceId)"
              [id]="'choice-' + choice.choiceId"
              [disabled]="isTimeUp || submitting">
            <label class="form-check-label w-100" [for]="'choice-' + choice.choiceId">
              {{ choice.choiceText }}
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="card-footer bg-transparent">
      <div class="d-flex justify-content-between">
        <button 
          class="btn btn-outline-secondary"
          (click)="previousQuestion()"
          [disabled]="currentQuestionIndex === 0 || isTimeUp || submitting">
          <i class="bi bi-arrow-left"></i> Previous
        </button>

        <button 
          *ngIf="currentQuestionIndex < quiz.questions.length - 1"
          class="btn btn-primary"
          (click)="nextQuestion()"
          [disabled]="isTimeUp || submitting">
          Next <i class="bi bi-arrow-right"></i>
        </button>

        <button 
          *ngIf="currentQuestionIndex === quiz.questions.length - 1"
          class="btn btn.success"
          (click)="submitQuiz()"
          [disabled]="submitting || isTimeUp">
          <i class="bi bi-check-circle"></i> Submit Quiz
        </button>
      </div>
    </div>
  </div>

  <!-- Question Navigator -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h6 class="mb-3">Question Navigator</h6>
      <div class="question-navigator">
        <button
          *ngFor="let question of quiz.questions; let i = index"
          class="btn btn-sm m-1"
          [class.btn-success]="isQuestionAnswered(i)"
          [class.btn-outline-secondary]="!isQuestionAnswered(i)"
          [class.btn-primary]="i === currentQuestionIndex"
          (click)="goToQuestion(i)"
          [disabled]="isTimeUp || submitting">
          {{ i + 1 }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading -->
<div *ngIf="loading" class="text-center mt-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-3">Loading quiz...</p>
</div>
